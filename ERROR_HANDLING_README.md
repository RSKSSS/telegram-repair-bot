# Система логирования и оповещения об ошибках

## Обзор

В проект добавлена расширенная система логирования и оповещения администраторов о критических ошибках. Эта система обеспечивает следующие возможности:

1. Структурированное логирование в файлы с ротацией
2. Отправка уведомлений администраторам в Telegram при возникновении ошибок
3. Предотвращение запуска нескольких экземпляров бота
4. Автоматическое восстановление работы при временных сбоях
5. Группировка похожих ошибок для предотвращения спама уведомлениями

## Структура системы

### Новые файлы

1. **setup_logging.py** - настройка системы логирования с разными типами логов и их ротацией
2. **admin_notifications.py** - система отправки уведомлений администраторам
3. **single_instance_bot.py** - проверка, что запущен только один экземпляр бота
4. **deploy_bot.py** - основной файл для запуска бота на Render с обработкой ошибок

### Структура логов

Логи сохраняются в директории `logs/` со следующей структурой:

- `bot.log` - основной лог с информацией о работе бота
- `errors.log` - лог с ошибками и предупреждениями
- `database.log` - лог операций с базой данных
- `api.log` - лог взаимодействия с API Telegram
- `admin/admin_actions.log` - лог действий администраторов
- `analytics.json` - структурированный JSON-лог для последующего анализа

## Запуск бота

### В среде разработки

Для запуска бота в среде разработки используйте:

```bash
python deploy_bot.py
```

Система автоматически настроит логирование и запустит бота с обработкой ошибок.

### На Render.com

Для деплоя бота на Render, используйте следующие настройки:

1. **Start Command**: `python deploy_bot.py`
2. **Environment Variables**:
   - `TELEGRAM_BOT_TOKEN`: [ваш токен бота]
   - `RENDER`: `true`
   - `DATABASE_URL`: [URL вашей базы данных, если используется]
   - `LOG_LEVEL`: `INFO` (опционально, по умолчанию `INFO`)

## Настройка оповещений

Система автоматически определяет администраторов на основе ролей в базе данных и отправляет им уведомления о критических ошибках.

### Уровни серьезности ошибок

1. **LOW** - информационные сообщения (запуск бота, плановые операции)
2. **MEDIUM** - предупреждения, требующие внимания
3. **HIGH** - серьезные ошибки, требующие вмешательства
4. **CRITICAL** - критические ошибки, требующие немедленной реакции

### Ручная отправка уведомлений

Для ручной отправки уведомлений используйте функции из `admin_notifications.py`:

```python
from admin_notifications import notify_info, notify_warning, notify_error, notify_critical

# Информационное сообщение
notify_info("Сервис успешно запущен")

# Предупреждение
notify_warning("Достигнут лимит обращений к API")

# Серьезная ошибка
notify_error("Ошибка подключения к базе данных", exception=e)

# Критическая ошибка
notify_critical("Сервис недоступен", exception=e, context={"attempts": 5})
```

## Логирование действий администраторов

Для логирования действий администраторов используйте функцию `log_admin_action`:

```python
from admin_notifications import log_admin_action

# Логирование действия администратора
log_admin_action(
    admin_id=12345,           # ID администратора
    action="delete_user",      # Тип действия
    target_id=67890,           # ID объекта действия (пользователь/заказ)
    details={"reason": "Спам"} # Дополнительные сведения
)
```

## Отладка и обслуживание

### Анализ логов

Для быстрого анализа логов можно использовать следующие команды:

```bash
# Просмотр последних ошибок
tail -n 50 logs/errors.log

# Поиск по ключевому слову в логах
grep "Ошибка" logs/bot.log

# Анализ действий администраторов
tail -n 100 logs/admin/admin_actions.log
```

### Очистка устаревших логов

Система автоматически выполняет ротацию логов, но для ручной очистки старых файлов:

```bash
# Удаление логов старше 30 дней
find logs/ -type f -name "*.log.*" -mtime +30 -delete
```

## Рекомендации

1. Регулярно проверяйте логи на наличие повторяющихся ошибок
2. Настройте интервал отправки оповещений в `admin_notifications.py` при необходимости
3. При переносе бота на новый сервер, сначала запустите `setup_logging.py` для создания структуры директорий
4. Если вы обновляете бота, перезапустите его через `deploy_bot.py` для корректной инициализации обработчиков ошибок